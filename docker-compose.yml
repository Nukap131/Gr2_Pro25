version: "3.9"

services:

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    restart: always
    ports:
      - "1884:1883"
    volumes:
      - ./mosquitto:/mosquitto
      - ./logs/mosquitto:/var/log/mosquitto
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 1883 || exit 1"]
      interval: 5s
      retries: 5
    networks:
      - default

  questdb:
    image: questdb/questdb:latest
    container_name: questdb
    restart: always
    ports:
      - "9000:9000"
      - "8812:8812"
      - "9009:9009"
    volumes:
      - questdb_data:/var/lib/questdb
      - ./logs/questdb:/var/log/questdb
    healthcheck:
      test: ["CMD-SHELL", "grep -q ':2328' /proc/net/tcp || exit 1"]
      interval: 5s
      retries: 5
    networks:
      - default

  subscriber:
    build:
      context: ./subscriber
      dockerfile: Dockerfile
    container_name: subscriber
    restart: always
    depends_on:
      mosquitto:
        condition: service_healthy
      questdb:
        condition: service_healthy
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - QUESTDB_HTTP=http://questdb:9000/exec
    volumes:
      - ./subscriber:/app
      - ./logs/subscriber:/var/log/subscriber
    networks:
      - default

  fastapi-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: fastapi-api
    restart: always
    depends_on:
      questdb:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
      - ./logs/api:/var/log/api
    networks:
      - default

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile.dashboard
    container_name: dashboard
    restart: always
    depends_on:
      - fastapi-api
    ports:
      - "8501:8501"
    volumes:
      - ./dashboard:/app
      - ./logs/dashboard:/var/log/dashboard
    networks:
      - default

volumes:
  questdb_data:

networks:
  default:
    name: tempprojekt-net
